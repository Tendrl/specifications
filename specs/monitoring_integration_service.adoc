= Spec - monitoring-integration should run as a daemon

== Introduction

Monitoring Integration component is responsible for the integration of tendrl with
grafana.

In the present implementation of monitoring-integration, to upload dashboards in
grafana, the user has to run the code manually every time; which is not feasible.
Monitoring integration will be providing other functionalities such as

* Handling alerts generated by grafana
* Making dynamic configuration changes in graphite and grafana

To accomplish the above, like other storage system integration pieces in tendrl,
monitoring-integration would also require to be able to run as a daemon, managed
via a systemd service.

== Proposed change

monitoring-integration component will be run as a daemon. Instead of starting each
and every times manually, it is installed and started once as a service managed
by systemd.

To be able to run as a daemon, the component needs some additional changes.

Mananger::
monitoring-integration execution flow is started from the Manager modules. Manager
module is the entry point for monitoring-integration, all the gevents are initialized
and started from the Manager modules. A Manager can kill all the gevent when
monitoring-integration service stops.
+
When monitoring-integration starts, the Manager module will do the all configurations
using configuration files. It will also create a separate namespace for the
monitoring-integration. the namespace will be called "NS.monitoring"

Namespace::
A manager will create its own namespace for the monitoring-integration to separate
its own objects from the other modules. These objects are only accessible by
monitoring-integration.

Object::
Each tendrl component has its own set of objects for a different purpose. Each
object have its own structure. monitoring-integration have an config and definition
object.

```
Sample config class for monitoring-integration:

class Config(objects.BaseObject):
    internal = True

    def __init__(self, config=None, *args, **kwargs):
        self._defs = {}
        super(Config, self).__init__(*args, **kwargs)

        self.data = config or cmn_config.load_config(
            'node-agent', "/etc/tendrl/monitoring-integration/monitoring-integration.conf.yaml")
        self.value = '_NS/monitoring/config'


Sample definition class for monitoring-integration:

class Definition(objects.BaseObject):
    internal = True

    def __init__(self, *args, **kwargs):
        self._defs = {}
        super(Definition, self).__init__(*args, **kwargs)

        self.data = pkg_resources.resource_string(__name__, "monitoring_integration.yaml")
        self._parsed_defs = yaml.safe_load(self.data)
        self.value = '_NS/monitoring/definitions'
```

Install and run:

monitoring-integration will be installed in server node only. It will be
installed and started by tendrl-ansible as a service. There is just one instance
of monitoring-integration installed across all clusters.

== Alternatives

None

== Data model impact:

monitoring-integration configuration and definition object are stored in etcd :
    * Configuration object path :  “_NS/monitoring/config”
    * Definition object path : "_NS/monitoring/definitions"

== Impacted Modules:

=== Tendrl API impact:

None

=== Notifications/Monitoring impact:

None

=== Tendrl/common impact:

None

=== Tendrl/node_agent impact:

None

=== Sds integration impact:

None


=== Tendrl/monitoring-integration impact:

Changes need to convert monitoring-integration as daemon:

* Create a module called manager in monitoring-integration
* Create a namespace for the monitoring-integration
* Create module called objects to place all monitoring-integration objects.

The implementation of these three modules is in the implementation section.

=== Security impact:

None

=== Other end user impact:

None

=== Performance impact:

None

=== Other deployer impact:

None

=== Developer impact:

Convert the monitoring-integration as service

== Implementation:

Steps to change monitoring-integration as service:

* Create a module called manager in tendrl/monitoring_integration.
* Create a file called "__init__.py" in tendrl/monitoring_integration/manager.
* A file "__init__.py" is the entry point for monitoring-integration. Create a
  main function in this file.
* The main function which is present at manager module will initiate the flow.
* Create a class called "MonitoringIntegrationManager" in "__init__.py" which is
  used to initialize all gevent classes.
* A class MonitoringIntegrationManager should be inherited from the base class called
  “Commons_manager.Manager”.
* Create a class called "MonitoringIntegrationNS" in tendrl/monitoring_integration/__init__.py
  to create a namespace.
* A class "MonitoringIntegrationNS" should be a subclass of "TendrlNS".
* Create a module called objects in tendrl/monitoring_integration/
* Create an object called "Config" in tendrl/monitoring_integration/objects
* The main function in manager should create the namespace using "MonitoringIntegrationNS"
  class before actual flow starts.
* The main function in manager should initialize and start the all gevent classes using "MonitoringIntegrationManager"
  class.
* The manager should stop all gevents when monitoring-integration service is stopped.
* Create a file tendrl-monitoring-integration.service systemd unit, and modify the
  tendrl-monitoring-integration.spec to copy it into systemd folder.

```
structure of manager:

class MonitoringIntegrationManager(common_manager.Manager):
    def __init__(self):
        # intialize gevents

     def start(self):
        # start gevents
def _upload_default_dashboards():
   # implementation to update or create grafana dashboard

def main():
  # create monitoring integration namespace
  # Initialize MonitoringIntegrationManager and call start()
  # stop all threads when stop signal is received
```

=== Assignee(s):

@GowthamShanmugam

@rishubhjain

== Work Items:

https://github.com/Tendrl/specifications/issues/179


== Testing:

* Check monitoring-integration works as expected after converted to service.
* Test the service start/stop/update rpm and make sure the config and definitions
  get loaded properly in etcd.

== Documentation impact:

None


== References:

https://github.com/Tendrl/specifications/pull/218

https://github.com/Tendrl/specifications/pull/198
